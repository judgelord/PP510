<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.555">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Resources for Policy Memos on Energy Project Siting</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="energy_files/libs/clipboard/clipboard.min.js"></script>
<script src="energy_files/libs/quarto-html/quarto.js"></script>
<script src="energy_files/libs/quarto-html/popper.min.js"></script>
<script src="energy_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="energy_files/libs/quarto-html/anchor.min.js"></script>
<link href="energy_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="energy_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="energy_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="energy_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="energy_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<style>

      .quarto-title-block .quarto-title-banner {
        background: #001B35;
      }
</style>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body>

<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Resources for Policy Memos on Energy Project Siting</h1>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
    
      
    </div>
    
  
  </header><div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Contents</h2>
   
  <ul>
  <li><a href="#michigan-policy" id="toc-michigan-policy" class="nav-link active" data-scroll-target="#michigan-policy">Michigan policy</a>
  <ul class="collapse">
  <li><a href="#plans" id="toc-plans" class="nav-link" data-scroll-target="#plans">Plans</a></li>
  <li><a href="#public-meetings" id="toc-public-meetings" class="nav-link" data-scroll-target="#public-meetings">Public meetings</a></li>
  <li><a href="#legislation" id="toc-legislation" class="nav-link" data-scroll-target="#legislation">Legislation</a>
  <ul class="collapse">
  <li><a href="#passed" id="toc-passed" class="nav-link" data-scroll-target="#passed">Passed</a></li>
  <li><a href="#in-the-works" id="toc-in-the-works" class="nav-link" data-scroll-target="#in-the-works">In the works</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#news" id="toc-news" class="nav-link" data-scroll-target="#news">News</a></li>
  <li><a href="#opinion" id="toc-opinion" class="nav-link" data-scroll-target="#opinion">Opinion</a></li>
  <li><a href="#reports" id="toc-reports" class="nav-link" data-scroll-target="#reports">Reports</a>
  <ul class="collapse">
  <li><a href="#roadmap-to-clean-equitable-power-in-michigan-by-university-of-michigan-law-school-problem-solving-initiative-course---winter-2024" id="toc-roadmap-to-clean-equitable-power-in-michigan-by-university-of-michigan-law-school-problem-solving-initiative-course---winter-2024" class="nav-link" data-scroll-target="#roadmap-to-clean-equitable-power-in-michigan-by-university-of-michigan-law-school-problem-solving-initiative-course---winter-2024">Roadmap to Clean &amp; Equitable Power in Michigan By University of Michigan Law School Problem Solving Initiative Course - Winter 2024</a></li>
  <li><a href="#mpps-report-most-michigan-local-government-officials-say-control-over-renewable-energy-projects-should-stay-local" id="toc-mpps-report-most-michigan-local-government-officials-say-control-over-renewable-energy-projects-should-stay-local" class="nav-link" data-scroll-target="#mpps-report-most-michigan-local-government-officials-say-control-over-renewable-energy-projects-should-stay-local">MPPS Report: Most Michigan local government officials say control over renewable energy projects should stay local</a></li>
  <li><a href="#laws-in-order-an-inventory-of-state-renewable-energy-siting-policies" id="toc-laws-in-order-an-inventory-of-state-renewable-energy-siting-policies" class="nav-link" data-scroll-target="#laws-in-order-an-inventory-of-state-renewable-energy-siting-policies">Laws in Order: An Inventory of State Renewable Energy Siting Policies</a></li>
  </ul></li>
  <li><a href="#secondary-sources" id="toc-secondary-sources" class="nav-link" data-scroll-target="#secondary-sources">Secondary sources</a></li>
  <li><a href="#peer-reviewed-research" id="toc-peer-reviewed-research" class="nav-link" data-scroll-target="#peer-reviewed-research">Peer-reviewed research</a></li>
  <li><a href="#wiki" id="toc-wiki" class="nav-link" data-scroll-target="#wiki">Wiki</a></li>
  </ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
</div>
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="michigan-policy" class="level1">
<h1>Michigan policy</h1>
<section id="plans" class="level2">
<h2 class="anchored" data-anchor-id="plans">Plans</h2>
<p><a href="https://www.michigan.gov/egle/about/organization/climate-and-energy/mi-healthy-climate-plan">MI Healthy Climate Plan</a></p>
<p><a href="https://www.a2gov.org/departments/sustainability/Carbon-Neutrality/Pages/default.aspx"><span class="math inline">\(A^2ZERO\)</span> — Building a just transition to community-wide carbon neutrality by 2030.</a></p>
</section>
<section id="public-meetings" class="level2">
<h2 class="anchored" data-anchor-id="public-meetings">Public meetings</h2>
<p><a href="https://www.youtube.com/watch?v=Z9IK_tm6f28">MPSC Renewable Energy and Energy Storage Siting Meeting 04-26-2024</a></p>
</section>
<section id="legislation" class="level2">
<h2 class="anchored" data-anchor-id="legislation">Legislation</h2>
<section id="passed" class="level3">
<h3 class="anchored" data-anchor-id="passed">Passed</h3>
<p><a href="https://www.legislature.mi.gov/documents/2023-2024/publicact/htm/2023-PA-0233.htm">Public Act No.&nbsp;233, Approved by the Governor, November 28, 2023</a></p>
<ul>
<li>Expands renewables siting authority to the MPSC for wind farms with a nameplate capacity over 100 MW and solar farms with a nameplate capacity over 50 MW</li>
<li>Directed MPSC staff to engage with developers, local governments, and experts to produce recommendations for filings, ordinance guidance, and more.</li>
</ul>
<p>PA 229</p>
<ul>
<li>Increases the energy waste reduction target for utilities, requires program participation for cooperative and municipal utilities, and requires spending on low-income customers</li>
<li>Directed MPSC staff to work with utilities, state government, and low-income advocacy groups to develop income verification strategies and program coordination to minimize barriers to participation</li>
</ul>
<p>PA 235</p>
<ul>
<li>Increases the RES to 50% by 2030 and 60% by 2035 and requires 100% clean energy by 2040</li>
<li>Distributed Generation (DG) floor increase to 10%</li>
<li>Establish a 2,500-megawatt storage standard by 2030</li>
<li>Requires that MPSC study and report electric issues unique to the Upper Peninsula (UP)</li>
<li>Set dates for all Michigan electricity providers to file amended REPs in 2024 and 2025</li>
<li>Seek comments on issues related to the DG cap and other relevant matters</li>
<li>Directed staff to draft a proposal to aid in determining a standard methodology for determining energy suppliers’ energy storage targets and to develop a report on energy storage resources. They will also require IOUs to file energy storage reports</li>
<li>Directed staff to engage with UP utilities and interconnection groups to develop the study, conduct at least one public hearing in the UP, and provide an opportunity for public comments</li>
</ul>
<p>PA 231</p>
<ul>
<li>Allows MPSC to consider climate, equity, and affordability in Integrated Resource Plans (IRPs)</li>
<li>Directed staff to commence studies on the potential for energy waste reduction, transportation electrification, demand response, buildings, and industry. Directed staff to update IRP filing requirements.</li>
</ul>
</section>
<section id="in-the-works" class="level3">
<h3 class="anchored" data-anchor-id="in-the-works">In the works</h3>
<p>The Michigan Association of Planning (MAP) Law Committee were approached by legislators in April 2024 seeking simple fixes to PA 233 that wouldn’t change the meaning/intent of the law, but would make it clearer to implement and resolve some of the ambiguities. Sarah Mills was part of a MAP subcommittee that worked to draft these. Most of these changes are what appeared in the staff straw proposal. MAP is continuing to work with the legislators, MAC, MTA, and MML. <a href="INSERT%20LINK">PDF</a></p>
</section>
</section>
</section>
<section id="news" class="level1">
<h1>News</h1>
<p><a href="https://www.washingtonpost.com/politics/2023/11/01/michigan-gov-gretchen-whitmer-might-notch-big-climate-win/">Michigan Gov.&nbsp;Gretchen Whitmer might notch a big climate win</a></p>
<p><a href="https://michiganadvance.com/2023/11/07/clean-energy-package-policy-changes-earn-mixed-response-from-environmental-advocates/">Clean energy package policy changes earn a mixed response from environmental advocates</a></p>
</section>
<section id="opinion" class="level1">
<h1>Opinion</h1>
<p><a href="https://www.bridgemi.com/guest-commentary/opinion-michigans-system-approve-green-energy-projects-broken">Michigan’s system to approve green energy projects is broken</a></p>
</section>
<section id="reports" class="level1">
<h1>Reports</h1>
<section id="roadmap-to-clean-equitable-power-in-michigan-by-university-of-michigan-law-school-problem-solving-initiative-course---winter-2024" class="level2">
<h2 class="anchored" data-anchor-id="roadmap-to-clean-equitable-power-in-michigan-by-university-of-michigan-law-school-problem-solving-initiative-course---winter-2024"><a href="https://www.miclimateaction.org/establish_michigan_as_a_climate_leader">Roadmap to Clean &amp; Equitable Power in Michigan By University of Michigan Law School Problem Solving Initiative Course - Winter 2024</a></h2>
</section>
<section id="mpps-report-most-michigan-local-government-officials-say-control-over-renewable-energy-projects-should-stay-local" class="level2">
<h2 class="anchored" data-anchor-id="mpps-report-most-michigan-local-government-officials-say-control-over-renewable-energy-projects-should-stay-local"><a href="https://closup.umich.edu/news/2024/new-mpps-report-most-michigan-local-government-officials-say-control-over-renewable">MPPS Report: Most Michigan local government officials say control over renewable energy projects should stay local</a></h2>
</section>
<section id="laws-in-order-an-inventory-of-state-renewable-energy-siting-policies" class="level2">
<h2 class="anchored" data-anchor-id="laws-in-order-an-inventory-of-state-renewable-energy-siting-policies"><a href="https://emp.lbl.gov/publications/laws-order-inventory-state-renewable">Laws in Order: An Inventory of State Renewable Energy Siting Policies</a></h2>
<p>Before a large-scale solar or wind project can be built, its developers face the complicated siting and permitting processes. A project could require approvals from multiple levels of government (federal, tribal, state, and local) that consider project aesthetics, economics, land use, and effects on water quality and wildlife habitat.</p>
<p>To simplify this complex web of energy regulations for policymakers, developers, and renewable energy stakeholders, Lawrence Berkeley National Laboratory and the U.S. Department of Energy’s (DOE) Office of Renewable Energy and Energy Efficiency collaborated with a research team that included the Regulatory Assistance Project, Clean Air Task Force, and the Consensus Building Institute to publish a new inventory of state renewable energy siting policies, permitting authorities, and an accompanying interactive map that profiles all 50 states plus Puerto Rico.</p>
<p>The inventory includes summary material, findings, and individual reports for each state.</p>
<p>It also provides an improved understanding of the regulatory landscape for large-scale wind and solar siting across U.S. states and territories by documenting, among other aspects:</p>
<p>The entity or entities in each state or territory that have jurisdictional authority to make siting and permitting decisions and set standards for large-scale renewables siting and construction; The presence or lack thereof of siting and permitting timelines; Public involvement requirements; and The availability of permitting guides and model ordinances to support local jurisdictional decision-making.</p>
<p>A key finding in the report is that a majority of states (37) give local governments the authority to set siting standards (tip heights, setbacks, etc.). Beyond that, our research confirms that state approaches to siting and permitting can vary widely and are often difficult to categorize.</p>
<p>Additional observations from the report include:</p>
<p>The level of government with principal authority for renewable energy siting and permitting often depends on project size. In 27 states, principal authority for siting and permitting depends on project size (shown below as “contingent”), with larger projects typically sited at the state level—though project size thresholds differ significantly from state to state.</p>
<p><img src="figs/emp-report-1.png" class="img-fluid"> Figure 1: Principal renewable energy siting and permitting authority categories by state</p>
<p>Note: “Local” refers to states where local governments have principal jurisdiction over renewable energy siting and permitting; “State” refers to when a state or territorial government has principal jurisdiction; “Both” refers to scenarios in which both the state and the local government have some authority; and, “Contingent” scenarios are when either the state or local government has principal authority, nearly always depending upon the size of the project.</p>
<p>Timelines for permitting vary widely. In 31 states, there are defined timelines for the permitting process, ranging from 30 days to a year. These timelines are often triggered by a specific initiation point, such as the developer applying for permission to build a project.</p>
<p>Most states have public involvement requirements. In 34 states – mostly those where the state has authority by default or based on project – the state has a statutory or regulatory requirement within the permitting process to include public meetings or hearings.</p>
<p>Published guidance is available in many states. We found that 29 states have published guides for siting and permitting solar, 33 for wind, and 25 for both solar and wind (Figure 2). These guides typically summarize the siting process, involved parties, and relevant policies, are often published by a state agency, but can sometimes be the product of nonprofits or working groups serving a state or region.</p>
<p><img src="figs/emp-report-2.png" class="img-fluid"> (Figure 2: Renewable energy permitting guides available)</p>
<p>Model ordinances are available in many states. Because local governments have a key role in setting siting rules in most states, some have developed model ordinances for local authorities to use as guides. Model ordinances are available in 27 states for solar, 18 for wind, and 15 for both.</p>
<p>Local authorities typically control siting standards. Solar or wind projects must meet standards to manage land use and regulate their development and construction. For example, there may be restrictions on how much land a project can use, where it can be built, or on wind turbine height and noise. These standards can be included in state law or a local zoning ordinance, but our research finds that 37 states give local authorities the jurisdiction to set siting standards.</p>
</section>
</section>
<section id="secondary-sources" class="level1">
<h1>Secondary sources</h1>
<p>(Reviews of research)</p>
<p><a href="https://theconversation.com/its-the-economics-red-states-embracing-wind-energy-dont-do-it-for-the-climate-104899">It’s the economics: Red states embracing wind energy don’t do it for the climate - Sarah Mills in The Conversation</a></p>
</section>
<section id="peer-reviewed-research" class="level1">
<h1>Peer-reviewed research</h1>
<p><a href="https://www.sciencedirect.com/science/article/pii/S0301421524001848?dgcid=raven_sd_via_email">Community-developer collaboration and voluntary community benefits in Scotland: Are community benefits a gift or compensation?</a></p>
<p><a href="https://www.sciencedirect.com/science/article/pii/S0301421524002192?dgcid=raven_sd_via_email">Community-based wind energy development does not work? Empirical evidence from residents in Canada and Ireland</a></p>
<p><a href="https://www.sciencedirect.com/science/article/pii/S0301421520306601">Renewable energy requirements on the ballot: An analysis of county-level voting results</a></p>
<p><a href="https://deepblue.lib.umich.edu/bitstream/handle/2027.42/111508/sbmills_1.pdf?sequence=1&amp;isAllowed=y">Preserving Agriculture through Wind Energy Development: A Study of the Social, Economic, and Land Use Effects of Windfarms on Rural Landowners and Their Communities by Sarah Mills, PhD Thesis, University of Michigan, 2015</a> - See passage on Ohio siting authority, starts on page 164 of the pdf/149 marked on the bottom of the page</p>
</section>
<section id="wiki" class="level1">
<h1><a href="https://docs.google.com/document/d/1JXMjQyCxCCgnQ9jALE8k8rdS4N8TuESqwbBY0Y950ek/edit?usp=sharing">Wiki</a></h1>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>